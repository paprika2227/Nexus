<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard - Nexus Bot Admin</title>
    <link
      rel="icon"
      type="image/webp"
      href="https://cdn.discordapp.com/avatars/1444739230679957646/32f2d77d44c2f3989fecd858be53f396.webp?size=256"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="pages.css" />
    <style>
      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        text-align: center;
        border-radius: 15px;
        margin-bottom: 40px;
      }

      .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        transition: all 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .stat-card h3 {
        font-size: 1rem;
        opacity: 0.8;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .value {
        font-size: 3rem;
        font-weight: 900;
        background: linear-gradient(135deg, #fff 0%, #ffd700 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .analytics-section {
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .analytics-section h2 {
        margin-bottom: 20px;
        font-size: 1.8rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .data-table th,
      .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .data-table th {
        background: rgba(255, 255, 255, 0.1);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 1px;
      }

      .data-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .click-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
      }

      .click-item strong {
        color: #ffd700;
      }

      .filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .filter-bar select,
      .filter-bar input {
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        flex: 1;
        min-width: 200px;
      }

      .filter-bar select:focus,
      .filter-bar input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-export {
        background: #667eea;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-export:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-refresh {
        background: #00d1b2;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-refresh:hover {
        background: #00b89c;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 1.2rem;
        opacity: 0.7;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        opacity: 0.7;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .chart-container {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        min-height: 300px;
      }

      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .heatmap-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s;
      }

      .heatmap-item.hot {
        border-color: #ff4444;
        background: rgba(255, 68, 68, 0.2);
      }

      .heatmap-item.warm {
        border-color: #ffaa00;
        background: rgba(255, 170, 0, 0.2);
      }

      .heatmap-item.cool {
        border-color: #00d1b2;
        background: rgba(0, 209, 178, 0.2);
      }

      .heatmap-item .label {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 5px;
      }

      .heatmap-item .count {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .auth-screen {
        max-width: 500px;
        margin: 100px auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 15px;
        text-align: center;
      }

      .auth-screen input {
        width: 100%;
        padding: 15px;
        margin: 20px 0;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
      }

      .auth-screen button {
        width: 100%;
        padding: 15px;
        background: #667eea;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
      }

      .error-message {
        color: #ff4444;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div id="auth-screen" class="auth-screen">
      <h1>üîí Admin Analytics</h1>
      <p>Enter admin password to view analytics</p>
      <input
        type="password"
        id="admin-password"
        placeholder="Admin Password"
      />
      <button onclick="authenticate()">Login</button>
      <p id="auth-error" class="error-message" style="display: none"></p>
    </div>

    <div id="dashboard-screen" style="display: none">
      <div class="container" style="margin-top: 100px">
        <div class="admin-header">
          <h1>üìä Analytics Dashboard</h1>
          <p>Real-time website analytics & click tracking</p>
          <p style="opacity: 0.7; margin-top: 10px">
            Last updated: <span id="last-update">Never</span>
          </p>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <select id="time-filter" onchange="loadAnalytics()">
            <option value="24h">Last 24 Hours</option>
            <option value="7d" selected>Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="all">All Time</option>
          </select>

          <select id="event-filter" onchange="filterEvents()">
            <option value="all">All Events</option>
            <option value="pageview">Page Views</option>
            <option value="click">Clicks</option>
            <option value="scroll">Scroll Events</option>
          </select>

          <button class="btn-refresh" onclick="loadAnalytics()">
            üîÑ Refresh
          </button>
          <button class="btn-export" onclick="exportData()">
            üì• Export CSV
          </button>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
          <div class="stat-card">
            <h3>Total Pageviews</h3>
            <div class="value" id="total-pageviews">0</div>
          </div>

          <div class="stat-card">
            <h3>Unique Sessions</h3>
            <div class="value" id="unique-sessions">0</div>
          </div>

          <div class="stat-card">
            <h3>Total Clicks</h3>
            <div class="value" id="total-clicks">0</div>
          </div>

          <div class="stat-card">
            <h3>Avg Session Time</h3>
            <div class="value" id="avg-session">0s</div>
          </div>
        </div>

        <!-- Top Pages -->
        <div class="analytics-section">
          <h2>üìÑ Top Pages</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>Page</th>
                <th>Views</th>
                <th>% of Total</th>
              </tr>
            </thead>
            <tbody id="top-pages-body">
              <tr>
                <td colspan="3" class="loading">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Click Heatmap -->
        <div class="analytics-section">
          <h2>üî• Click Heatmap</h2>
          <p style="opacity: 0.8; margin-bottom: 20px">
            Most clicked elements (color = frequency)
          </p>
          <div class="heatmap-grid" id="click-heatmap">
            <div class="loading">Loading...</div>
          </div>
        </div>

        <!-- Recent Events -->
        <div class="analytics-section">
          <h2>üïê Recent Events</h2>
          <div id="recent-events">
            <div class="loading">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const ANALYTICS_API =
        "https://regular-puma-clearly.ngrok-free.app/api/analytics/dashboard";
      const ADMIN_API =
        "https://regular-puma-clearly.ngrok-free.app/api/admin/auth";

      let authToken = localStorage.getItem("admin_token");
      let analyticsData = null;

      // Check if already authenticated
      if (authToken) {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("dashboard-screen").style.display = "block";
        loadAnalytics();
      }

      async function authenticate() {
        const password = document.getElementById("admin-password").value;
        const errorEl = document.getElementById("auth-error");

        try {
          const response = await fetch(ADMIN_API, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ password }),
          });

          if (response.ok) {
            const data = await response.json();
            authToken = data.token;
            localStorage.setItem("admin_token", authToken);

            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("dashboard-screen").style.display = "block";
            loadAnalytics();
          } else {
            errorEl.textContent = "Invalid password";
            errorEl.style.display = "block";
          }
        } catch (error) {
          errorEl.textContent = "Connection error: " + error.message;
          errorEl.style.display = "block";
        }
      }

      async function loadAnalytics() {
        try {
          const response = await fetch(ANALYTICS_API, {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "ngrok-skip-browser-warning": "true",
            },
          });

          if (!response.ok) {
            if (response.status === 401) {
              // Token expired
              localStorage.removeItem("admin_token");
              location.reload();
              return;
            }
            throw new Error("Failed to load analytics");
          }

          analyticsData = await response.json();
          displayAnalytics();
        } catch (error) {
          console.error("Error loading analytics:", error);
          alert("Failed to load analytics: " + error.message);
        }
      }

      function displayAnalytics() {
        if (!analyticsData) return;

        // Update overview stats
        document.getElementById("total-pageviews").textContent =
          analyticsData.totalPageviews.toLocaleString();
        document.getElementById("unique-sessions").textContent =
          analyticsData.uniqueSessions.toLocaleString();
        document.getElementById("total-clicks").textContent =
          analyticsData.totalClicks.toLocaleString();
        document.getElementById("avg-session").textContent =
          analyticsData.avgSessionDuration || "0s";

        // Update last update time
        document.getElementById("last-update").textContent =
          new Date().toLocaleTimeString();

        // Display top pages
        const topPagesBody = document.getElementById("top-pages-body");
        topPagesBody.innerHTML = "";

        if (analyticsData.topPages.length === 0) {
          topPagesBody.innerHTML = `
            <tr>
              <td colspan="3" class="empty-state">
                <h3>No data yet</h3>
                <p>Analytics will appear once users visit the site</p>
              </td>
            </tr>
          `;
        } else {
          const totalViews = analyticsData.topPages.reduce(
            (sum, p) => sum + p.views,
            0
          );
          analyticsData.topPages.forEach((page) => {
            const percentage = ((page.views / totalViews) * 100).toFixed(1);
            topPagesBody.innerHTML += `
              <tr>
                <td><strong>${page.page}</strong></td>
                <td>${page.views.toLocaleString()}</td>
                <td>${percentage}%</td>
              </tr>
            `;
          });
        }

        // Display click heatmap
        const heatmapEl = document.getElementById("click-heatmap");
        heatmapEl.innerHTML = "";

        if (analyticsData.clickHeatmap.length === 0) {
          heatmapEl.innerHTML = `
            <div class="empty-state">
              <h3>No clicks yet</h3>
              <p>Click data will appear here</p>
            </div>
          `;
        } else {
          const maxClicks = Math.max(
            ...analyticsData.clickHeatmap.map((c) => c.clicks)
          );
          analyticsData.clickHeatmap.forEach((item) => {
            const intensity = item.clicks / maxClicks;
            let heatClass = "cool";
            if (intensity > 0.7) heatClass = "hot";
            else if (intensity > 0.3) heatClass = "warm";

            heatmapEl.innerHTML += `
              <div class="heatmap-item ${heatClass}">
                <div class="label">${item.text || item.type || "Element"}</div>
                <div class="count">${item.clicks}</div>
              </div>
            `;
          });
        }

        // Display recent events (simulated - would need real-time data)
        const recentEventsEl = document.getElementById("recent-events");
        recentEventsEl.innerHTML = `
          <div class="empty-state">
            <p>Real-time event stream coming soon!</p>
            <p style="font-size: 0.9rem; margin-top: 10px">For now, check the database or API directly for recent events</p>
          </div>
        `;
      }

      function filterEvents() {
        // Would filter the displayed events
        console.log("Filter events:", document.getElementById("event-filter").value);
      }

      function exportData() {
        if (!analyticsData) {
          alert("No data to export");
          return;
        }

        // Create CSV
        let csv = "Page,Views,Percentage\n";
        const totalViews = analyticsData.topPages.reduce(
          (sum, p) => sum + p.views,
          0
        );
        analyticsData.topPages.forEach((page) => {
          const percentage = ((page.views / totalViews) * 100).toFixed(1);
          csv += `"${page.page}",${page.views},${percentage}%\n`;
        });

        csv += "\n\nClick Heatmap\n";
        csv += "Element,Clicks\n";
        analyticsData.clickHeatmap.forEach((item) => {
          csv += `"${item.text || item.type}",${item.clicks}\n`;
        });

        // Download
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nexus-analytics-${new Date().toISOString().split("T")[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      // Auto-refresh every 60 seconds
      setInterval(() => {
        if (document.getElementById("dashboard-screen").style.display !== "none") {
          loadAnalytics();
        }
      }, 60000);

      // Handle enter key on password field
      document.getElementById("admin-password").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          authenticate();
        }
      });
    </script>
  </body>
</html>

