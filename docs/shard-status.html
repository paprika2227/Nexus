<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shard & Cluster Status - Nexus Bot</title>
    <link
      rel="icon"
      type="image/webp"
      href="https://cdn.discordapp.com/avatars/1444739230679957646/32f2d77d44c2f3989fecd858be53f396.webp?size=256"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #0d1117;
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      .header {
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #fff;
      }

      .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }

      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .legend-dot.operational {
        background: #4caf50;
      }

      .legend-dot.partial {
        background: #ff9800;
      }

      .legend-dot.outage {
        background: #f44336;
      }

      .search-bar {
        margin-bottom: 20px;
      }

      .search-bar input {
        width: 100%;
        max-width: 400px;
        padding: 12px 16px;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #fff;
        font-size: 1rem;
      }

      .search-bar input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .search-bar input::placeholder {
        color: #8b949e;
      }

      .summary {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .summary h2 {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: #fff;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .summary-stat {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .summary-stat-label {
        font-size: 0.85rem;
        color: #8b949e;
      }

      .summary-stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #fff;
      }

      .summary-stat-value.problem {
        color: #ff9800;
      }

      .summary-stat-value.critical {
        color: #f44336;
      }

      .shards-section {
        margin-bottom: 40px;
      }

      .section-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: #fff;
      }

      .shards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 20px;
      }

      .shard-item,
      .cluster-item {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 0.85rem;
        font-weight: 500;
        color: #58a6ff;
      }

      .shard-item:hover,
      .cluster-item:hover {
        transform: scale(1.1);
        z-index: 10;
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .shard-item.operational,
      .cluster-item.operational {
        background: #1a472a;
        border-color: #238636;
        color: #4caf50;
      }

      .shard-item.partial,
      .cluster-item.partial {
        background: #3d2811;
        border-color: #d29922;
        color: #ff9800;
      }

      .shard-item.outage,
      .cluster-item.outage {
        background: #3d1f1f;
        border-color: #da3633;
        color: #f44336;
      }

      .tooltip {
        position: absolute;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 16px;
        min-width: 280px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .tooltip.visible {
        opacity: 1;
      }

      .tooltip-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: #fff;
      }

      .tooltip-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }

      .tooltip-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        border-bottom: 1px solid #21262d;
      }

      .tooltip-row:last-child {
        border-bottom: none;
      }

      .tooltip-label {
        color: #8b949e;
      }

      .tooltip-value {
        color: #fff;
        font-weight: 500;
      }

      .tooltip-value.warning {
        color: #ff9800;
      }

      .tooltip-value.error {
        color: #f44336;
      }

      .tooltip-arrow {
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #30363d;
      }

      .tooltip-arrow::after {
        content: "";
        position: absolute;
        bottom: 1px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        border-top: 7px solid #161b22;
      }

      .refresh-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .refresh-btn {
        padding: 10px 20px;
        background: #238636;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }

      .refresh-btn:hover {
        background: #2ea043;
      }

      .refresh-btn:disabled {
        background: #30363d;
        cursor: not-allowed;
      }

      .auto-refresh-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #8b949e;
        font-size: 0.9rem;
      }

      .auto-refresh-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #8b949e;
      }

      .error {
        background: #3d1f1f;
        border: 1px solid #da3633;
        color: #f44336;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .shards-grid {
          grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
          gap: 6px;
          padding: 15px;
        }

        .shard-item,
        .cluster-item {
          font-size: 0.75rem;
        }

        .tooltip {
          min-width: 240px;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Availability per service</h1>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-dot operational"></div>
            <span>Operational</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot partial"></div>
            <span>Partial Outage</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot outage"></div>
            <span>Major Outage</span>
          </div>
        </div>
      </div>

      <div class="search-bar">
        <input
          type="text"
          id="serverSearch"
          placeholder="Look up your server (by ID)"
        />
      </div>

      <div class="summary">
        <h2>Service: Nexus Bot</h2>
        <div class="summary-stats">
          <div class="summary-stat">
            <span class="summary-stat-label">Total Shards</span>
            <span class="summary-stat-value" id="totalShards">-</span>
          </div>
          <div class="summary-stat">
            <span class="summary-stat-label">Operational Shards</span>
            <span class="summary-stat-value" id="operationalShards">-</span>
          </div>
          <div class="summary-stat">
            <span class="summary-stat-label">Total Clusters</span>
            <span class="summary-stat-value" id="totalClusters">-</span>
          </div>
          <div class="summary-stat">
            <span class="summary-stat-label">Clusters with Problems</span>
            <span class="summary-stat-value" id="problemClusters">-</span>
          </div>
          <div class="summary-stat">
            <span class="summary-stat-label">Total Servers</span>
            <span class="summary-stat-value" id="totalGuilds">-</span>
          </div>
          <div class="summary-stat">
            <span class="summary-stat-label">Total Users</span>
            <span class="summary-stat-value" id="totalUsers">-</span>
          </div>
        </div>
      </div>

      <div class="refresh-controls">
        <button class="refresh-btn" onclick="loadStatus()" id="refreshBtn">
          üîÑ Refresh
        </button>
        <label class="auto-refresh-toggle">
          <input type="checkbox" id="autoRefresh" checked />
          <span>Auto-refresh every 5 seconds</span>
        </label>
      </div>

      <div id="clustersSection" style="display: none">
        <div class="shards-section">
          <h2 class="section-title">Clusters</h2>
          <div class="shards-grid" id="clustersGrid"></div>
        </div>
      </div>

      <div class="shards-section">
        <h2 class="section-title">Shards</h2>
        <div class="shards-grid" id="shardsGrid">
          <div class="loading">Loading shards...</div>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
      const API_BASE =
        window.NEXUS_API_URL || "https://regular-puma-clearly.ngrok-free.app";
      let refreshInterval = null;
      let tooltip = null;

      function getStatusClass(status, ping, uptime) {
        // Status 0 = READY
        if (status === 0 && ping < 200 && uptime > 0) {
          return "operational";
        }
        // Status 0 but high ping or issues
        if (status === 0 && (ping >= 200 || uptime === 0)) {
          return "partial";
        }
        // Status 5 = DISCONNECTED
        if (status === 5) {
          return "outage";
        }
        // Other connecting states
        return "partial";
      }

      function formatUptime(seconds) {
        if (!seconds || seconds === 0) return "0s";
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        if (days > 0) return `${days} d, ${hours} h, ${minutes} m, ${secs} s`;
        if (hours > 0) return `${hours} h, ${minutes} m, ${secs} s`;
        if (minutes > 0) return `${minutes} m, ${secs} s`;
        return `${secs} s`;
      }

      function formatMemory(bytes) {
        if (!bytes) return "N/A";
        const mb = bytes / 1024 / 1024;
        return `${mb.toFixed(1)} MB`;
      }

      function createTooltip(element, data, isCluster = false) {
        // Remove existing tooltip
        if (tooltip) {
          tooltip.remove();
        }

        tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.innerHTML = `
          <div class="tooltip-title">${isCluster ? `Cluster ${data.id}` : `Shard ${data.id}`}</div>
          <div class="tooltip-info">
            ${isCluster ? `
              <div class="tooltip-row">
                <span class="tooltip-label">Shards:</span>
                <span class="tooltip-value">${data.shardIds?.join(", ") || "N/A"}</span>
              </div>
            ` : ""}
            <div class="tooltip-row">
              <span class="tooltip-label">Servers:</span>
              <span class="tooltip-value">${(data.guilds || 0).toLocaleString()}</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Users:</span>
              <span class="tooltip-value">${(data.users || 0).toLocaleString()}</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Ping:</span>
              <span class="tooltip-value ${data.ping >= 200 ? "warning" : ""}">${data.ping || 0}ms</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Status:</span>
              <span class="tooltip-value ${data.status === 5 ? "error" : data.status === 0 ? "" : "warning"}">${getStatusText(data.status)}</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Uptime:</span>
              <span class="tooltip-value">${formatUptime(data.uptime || 0)}</span>
            </div>
            ${data.memory ? `
              <div class="tooltip-row">
                <span class="tooltip-label">Memory:</span>
                <span class="tooltip-value">${formatMemory(data.memory.heapUsed || data.memory)}</span>
              </div>
            ` : ""}
          </div>
          <div class="tooltip-arrow"></div>
        `;

        document.body.appendChild(tooltip);

        // Position tooltip
        const rect = element.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
        let top = rect.top - tooltipRect.height - 12;

        // Adjust if tooltip goes off screen
        if (left < 10) left = 10;
        if (left + tooltipRect.width > window.innerWidth - 10) {
          left = window.innerWidth - tooltipRect.width - 10;
        }
        if (top < 10) {
          top = rect.bottom + 12;
          tooltip.querySelector(".tooltip-arrow").style.top = "-8px";
          tooltip.querySelector(".tooltip-arrow").style.transform = "translateX(-50%) rotate(180deg)";
        }

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        tooltip.classList.add("visible");
      }

      function getStatusText(status) {
        const statusMap = {
          0: "READY",
          1: "CONNECTING",
          2: "RECONNECTING",
          3: "IDLE",
          4: "NEARLY",
          5: "DISCONNECTED",
          6: "WAITING_FOR_GUILDS",
          7: "IDENTIFYING",
          8: "RESUMING",
        };
        return statusMap[status] || "UNKNOWN";
      }

      function hideTooltip() {
        if (tooltip) {
          tooltip.remove();
          tooltip = null;
        }
      }

      async function loadStatus() {
        const refreshBtn = document.getElementById("refreshBtn");
        refreshBtn.disabled = true;
        refreshBtn.textContent = "üîÑ Loading...";

        try {
          const response = await window.apiCall("/api/shards");
          const data = response;

          // Update summary stats
          const shards = data.shards || [];
          const operationalShards = shards.filter(
            (s) => s.status === 0 && s.ping < 200 && s.uptime > 0
          ).length;
          const partialShards = shards.filter(
            (s) => s.status === 0 && (s.ping >= 200 || s.uptime === 0)
          ).length;
          const outageShards = shards.filter((s) => s.status === 5).length;

          document.getElementById("totalShards").textContent = shards.length;
          document.getElementById("operationalShards").textContent = `${operationalShards}/${shards.length}`;
          document.getElementById("totalGuilds").textContent = (
            data.totalGuilds || 0
          ).toLocaleString();
          document.getElementById("totalUsers").textContent = (
            data.totalUsers || 0
          ).toLocaleString();

          // Handle clusters
          if (data.clusters && data.clusters.clusters) {
            document.getElementById("clustersSection").style.display = "block";
            const clusters = data.clusters.clusters;
            const problemClusters = clusters.filter(
              (c) => c.status !== 0 || c.ping >= 200
            ).length;

            document.getElementById("totalClusters").textContent = clusters.length;
            document.getElementById("problemClusters").textContent = `${problemClusters}/${clusters.length}`;
            if (problemClusters > 0) {
              document.getElementById("problemClusters").classList.add("problem");
            }

            const clustersGrid = document.getElementById("clustersGrid");
            clustersGrid.innerHTML = clusters
              .map((cluster) => {
                const statusClass = getStatusClass(
                  cluster.status,
                  cluster.ping,
                  cluster.uptime
                );
                return `<div class="cluster-item ${statusClass}" data-cluster-id="${cluster.clusterId}">${cluster.clusterId}</div>`;
              })
              .join("");

            // Add hover events for clusters
            clustersGrid.querySelectorAll(".cluster-item").forEach((item) => {
              const clusterId = parseInt(item.dataset.clusterId);
              const clusterData = clusters.find((c) => c.clusterId === clusterId);
              item.addEventListener("mouseenter", (e) => {
                createTooltip(e.target, clusterData, true);
              });
              item.addEventListener("mouseleave", hideTooltip);
            });
          } else {
            document.getElementById("clustersSection").style.display = "none";
            document.getElementById("totalClusters").textContent = "N/A";
            document.getElementById("problemClusters").textContent = "N/A";
          }

          // Display shards
          const shardsGrid = document.getElementById("shardsGrid");
          if (shards && shards.length > 0) {
            shardsGrid.innerHTML = shards
              .map((shard) => {
                const statusClass = getStatusClass(
                  shard.status,
                  shard.ping,
                  shard.uptime
                );
                return `<div class="shard-item ${statusClass}" data-shard-id="${shard.id}">${shard.id}</div>`;
              })
              .join("");

            // Add hover events for shards
            shardsGrid.querySelectorAll(".shard-item").forEach((item) => {
              const shardId = parseInt(item.dataset.shardId);
              const shardData = shards.find((s) => s.id === shardId);
              item.addEventListener("mouseenter", (e) => {
                createTooltip(e.target, shardData, false);
              });
              item.addEventListener("mouseleave", hideTooltip);
            });
          } else {
            shardsGrid.innerHTML =
              '<div class="error">No shard data available</div>';
          }
        } catch (error) {
          console.error("Failed to load status:", error);
          document.getElementById("shardsGrid").innerHTML = `
            <div class="error">
              <h3>‚ùå Error Loading Status</h3>
              <p>${error.message}</p>
            </div>
          `;
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.textContent = "üîÑ Refresh";
        }
      }

      // Auto-refresh toggle
      document.getElementById("autoRefresh").addEventListener("change", (e) => {
        if (e.target.checked) {
          refreshInterval = setInterval(loadStatus, 5000);
        } else {
          if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
          }
        }
      });

      // Server search functionality
      document.getElementById("serverSearch").addEventListener("input", (e) => {
        const searchId = e.target.value.trim();
        if (!searchId) {
          // Reset all shards
          document.querySelectorAll(".shard-item, .cluster-item").forEach((item) => {
            item.style.border = "";
            item.style.boxShadow = "";
          });
          return;
        }

        // Highlight matching shard/cluster
        document.querySelectorAll(".shard-item, .cluster-item").forEach((item) => {
          if (item.textContent === searchId) {
            item.style.border = "2px solid #667eea";
            item.style.boxShadow = "0 0 10px rgba(102, 126, 234, 0.5)";
            item.scrollIntoView({ behavior: "smooth", block: "center" });
          } else {
            item.style.border = "";
            item.style.boxShadow = "";
          }
        });
      });

      // Initial load
      loadStatus();
      if (document.getElementById("autoRefresh").checked) {
        refreshInterval = setInterval(loadStatus, 5000);
      }
    </script>
  </body>
</html>
