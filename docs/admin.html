<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Hub - Nexus</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #fff;
      }

      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .login-box {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 50px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        max-width: 450px;
        width: 100%;
      }

      .login-box h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-align: center;
      }

      .login-box p {
        text-align: center;
        opacity: 0.9;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }

      input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1rem;
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .btn {
        width: 100%;
        padding: 15px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .btn-primary {
        background: #fff;
        color: #667eea;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
      }

      .error {
        background: rgba(255, 68, 68, 0.3);
        border: 2px solid #ff4444;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .admin-container {
        display: none;
        padding: 40px 20px;
      }

      .admin-header {
        max-width: 1200px;
        margin: 0 auto 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-header h1 {
        font-size: 2.5rem;
      }

      .btn-logout {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 10px;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }

      h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      textarea {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
      }

      select {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1rem;
      }

      .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .alert-success {
        background: rgba(0, 255, 0, 0.2);
        border: 2px solid #00ff00;
      }

      .alert-info {
        background: rgba(0, 170, 255, 0.2);
        border: 2px solid #00aaff;
      }

      .timeline-builder {
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .timeline-item {
        display: grid;
        grid-template-columns: 1fr 2fr auto;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-danger {
        background: #ff4444;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .incident-list {
        display: grid;
        gap: 20px;
        margin-top: 20px;
      }

      .incident-card {
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid;
      }

      .incident-card.resolved {
        border-color: #00ff00;
      }

      .incident-card.investigating {
        border-color: #ffaa00;
      }

      .incident-card.outage {
        border-color: #ff4444;
      }

      .incident-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
      <div class="login-box">
        <h1>üîê Admin Login</h1>
        <p>Enter admin password to manage incidents</p>

        <div id="loginError" class="error" style="display: none">
          ‚ùå Invalid password
        </div>

        <form onsubmit="login(event)">
          <div class="form-group">
            <label>Admin Password</label>
            <input
              type="password"
              id="adminPassword"
              placeholder="Enter password"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-container" id="adminPanel">
      <div class="admin-header">
        <h1>üõ†Ô∏è Admin Hub</h1>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>

      <div style="max-width: 1200px; margin: 0 auto">
        <p
          style="
            text-align: center;
            opacity: 0.9;
            font-size: 1.2rem;
            margin-bottom: 40px;
          "
        >
          Central hub for all Nexus administration tools
        </p>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
          "
        >
          <!-- Incidents Manager -->
          <a
            href="admin-incidents.html"
            style="text-decoration: none; color: inherit"
          >
            <div
              class="card"
              style="cursor: pointer; transition: all 0.3s; height: 100%"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#ffd700';"
              onmouseout="this.style.transform=''; this.style.borderColor='rgba(255,255,255,0.2)';"
            >
              <div style="text-align: center">
                <div style="font-size: 4rem; margin-bottom: 15px">üìù</div>
                <h2 style="margin-bottom: 10px">Incident Manager</h2>
                <p style="opacity: 0.8">
                  Create and manage status page incidents
                </p>
              </div>
            </div>
          </a>

          <!-- IP Logs Viewer -->
          <a
            href="admin-ips.html"
            style="text-decoration: none; color: inherit"
          >
            <div
              class="card"
              style="cursor: pointer; transition: all 0.3s; height: 100%"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#ffd700';"
              onmouseout="this.style.transform=''; this.style.borderColor='rgba(255,255,255,0.2)';"
            >
              <div style="text-align: center">
                <div style="font-size: 4rem; margin-bottom: 15px">üåê</div>
                <h2 style="margin-bottom: 10px">IP Logs</h2>
                <p style="opacity: 0.8">Track all website visitors and IPs</p>
              </div>
            </div>
          </a>

          <!-- Link Tracking -->
          <a
            href="admin-links.html"
            style="text-decoration: none; color: inherit"
          >
            <div
              class="card"
              style="cursor: pointer; transition: all 0.3s; height: 100%"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#10b981';"
              onmouseout="this.style.transform=''; this.style.borderColor='rgba(255,255,255,0.2)';"
            >
              <div style="text-align: center">
                <div style="font-size: 4rem; margin-bottom: 15px">üîó</div>
                <h2 style="margin-bottom: 10px">Link Tracking</h2>
                <p style="opacity: 0.8">Create and track invite sources</p>
              </div>
            </div>
          </a>

          <!-- Dashboard -->
          <a
            href="https://regular-puma-clearly.ngrok-free.app"
            target="_blank"
            style="text-decoration: none; color: inherit"
          >
            <div
              class="card"
              style="cursor: pointer; transition: all 0.3s; height: 100%"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#ffd700';"
              onmouseout="this.style.transform=''; this.style.borderColor='rgba(255,255,255,0.2)';"
            >
              <div style="text-align: center">
                <div style="font-size: 4rem; margin-bottom: 15px">üéõÔ∏è</div>
                <h2 style="margin-bottom: 10px">Main Dashboard</h2>
                <p style="opacity: 0.8">Manage bot settings and servers</p>
              </div>
            </div>
          </a>

          <!-- Back to Website -->
          <a href="index.html" style="text-decoration: none; color: inherit">
            <div
              class="card"
              style="cursor: pointer; transition: all 0.3s; height: 100%"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#667eea';"
              onmouseout="this.style.transform=''; this.style.borderColor='rgba(255,255,255,0.2)';"
            >
              <div style="text-align: center">
                <div style="font-size: 4rem; margin-bottom: 15px">üè†</div>
                <h2 style="margin-bottom: 10px">Back to Website</h2>
                <p style="opacity: 0.8">Return to Nexus homepage</p>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- OLD INCIDENT MANAGER (Hidden - use admin-incidents.html instead) -->
    <div style="display: none">
      <!-- Create Incident -->
      <div class="card">
        <h2>Create New Incident</h2>

        <div class="form-group">
          <label>Status</label>
          <select id="status">
            <option value="investigating">üîç Investigating</option>
            <option value="outage">üî¥ Outage</option>
            <option value="resolved">‚úÖ Resolved</option>
          </select>
        </div>

        <div class="form-group">
          <label>Title</label>
          <input
            type="text"
            id="title"
            placeholder="e.g., Brief Connection Issue"
          />
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea
            id="description"
            placeholder="Describe what happened..."
          ></textarea>
        </div>

        <div class="form-group">
          <label>Start Time</label>
          <input type="datetime-local" id="startTime" />
        </div>

        <div class="form-group">
          <label>End Time (leave empty if ongoing)</label>
          <input type="datetime-local" id="endTime" />
        </div>

        <div class="form-group">
          <label>Timeline Events</label>
          <div class="timeline-builder" id="timelineBuilder">
            <div class="timeline-item">
              <input type="time" placeholder="Time" class="timeline-time" />
              <input
                type="text"
                placeholder="Event description"
                class="timeline-text"
              />
              <button
                type="button"
                class="btn-danger"
                onclick="removeTimelineItem(this)"
              >
                Remove
              </button>
            </div>
          </div>
          <button
            type="button"
            class="btn-secondary"
            onclick="addTimelineItem()"
          >
            + Add Timeline Event
          </button>
        </div>

        <button class="btn btn-primary" onclick="createIncident()">
          Create Incident
        </button>
      </div>

      <!-- Current Incidents -->
      <div class="card">
        <h2>Current Incidents</h2>
        <div class="incident-list" id="incidentsList">
          <p style="opacity: 0.7">Loading incidents...</p>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "https://regular-puma-clearly.ngrok-free.app";
      let authToken = null;

      // Set current time as default
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById("startTime").value = now
        .toISOString()
        .slice(0, 16);

      async function login(event) {
        event.preventDefault();

        const password = document.getElementById("adminPassword").value;
        const errorDiv = document.getElementById("loginError");

        try {
          const response = await fetch(`${API_URL}/api/admin/auth`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ password }),
          });

          if (response.ok) {
            const data = await response.json();
            authToken = data.token;

            // Hide login, show admin panel
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("adminPanel").style.display = "block";

            loadIncidents();
          } else {
            errorDiv.style.display = "block";
          }
        } catch (error) {
          errorDiv.textContent = "‚ùå Could not connect to API";
          errorDiv.style.display = "block";
        }
      }

      function logout() {
        authToken = null;
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("adminPassword").value = "";
      }

      function addTimelineItem() {
        const builder = document.getElementById("timelineBuilder");
        const item = document.createElement("div");
        item.className = "timeline-item";
        item.innerHTML = `
        <input type="time" placeholder="Time" class="timeline-time">
        <input type="text" placeholder="Event description" class="timeline-text">
        <button type="button" class="btn-danger" onclick="removeTimelineItem(this)">Remove</button>
      `;
        builder.appendChild(item);
      }

      function removeTimelineItem(btn) {
        btn.parentElement.remove();
      }

      async function createIncident() {
        const status = document.getElementById("status").value;
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        if (!title || !description || !startTime) {
          alert(
            "Please fill in required fields: Title, Description, and Start Time"
          );
          return;
        }

        // Get timeline events
        const timelineItems = document.querySelectorAll(".timeline-item");
        const timeline = [];
        timelineItems.forEach((item) => {
          const time = item.querySelector(".timeline-time").value;
          const text = item.querySelector(".timeline-text").value;
          if (time && text) {
            const date = new Date(startTime);
            const [hours, minutes] = time.split(":");
            date.setHours(parseInt(hours), parseInt(minutes));
            timeline.push({
              time: date.toISOString(),
              text: text,
            });
          }
        });

        const incident = {
          status,
          title,
          description,
          startTime: new Date(startTime).toISOString(),
          endTime: endTime ? new Date(endTime).toISOString() : null,
          timeline,
        };

        try {
          const response = await fetch(`${API_URL}/api/admin/incidents`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify(incident),
          });

          if (response.ok) {
            // Show success
            const alert = document.getElementById("successAlert");
            alert.style.display = "block";
            setTimeout(() => {
              alert.style.display = "none";
            }, 3000);

            // Clear form
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("endTime").value = "";

            // Reload incidents
            loadIncidents();
          } else {
            alert("Failed to create incident");
          }
        } catch (error) {
          alert("Error creating incident: " + error.message);
        }
      }

      async function loadIncidents() {
        try {
          const response = await fetch("incidents.json");
          if (response.ok) {
            const data = await response.json();
            displayIncidents(data.incidents);
          }
        } catch (error) {
          document.getElementById("incidentsList").innerHTML =
            '<p style="opacity:0.7;">Could not load incidents</p>';
        }
      }

      function displayIncidents(incidents) {
        const list = document.getElementById("incidentsList");

        if (!incidents || incidents.length === 0) {
          list.innerHTML = '<p style="opacity:0.7;">No incidents found</p>';
          return;
        }

        list.innerHTML = incidents
          .map((incident) => {
            const startDate = new Date(incident.startTime);
            const statusEmoji =
              incident.status === "resolved"
                ? "‚úÖ"
                : incident.status === "investigating"
                ? "üîç"
                : "üî¥";

            return `
          <div class="incident-card ${incident.status}">
            <div class="incident-header-row">
              <div class="status-badge">${statusEmoji} ${incident.status.toUpperCase()}</div>
              <div style="opacity: 0.7;">${startDate.toLocaleString()}</div>
            </div>
            <h3>${incident.title}</h3>
            <p style="opacity: 0.8; margin-top: 10px;">${
              incident.description
            }</p>
          </div>
        `;
          })
          .join("");
      }
    </script>
  </body>
</html>
